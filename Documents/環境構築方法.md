
## 開発用マシンの構築

章の始めでも説明しましたが、この節ではクロスプラットフォーム開発環境を構築します。

この節で行うことを大まかに分けると、以下の2つになります。

 *  開発用マシンの用意
 *  クロス開発環境のインストール

本書ではクロスプラットフォーム開発環境をDebian（x86_64）7.0上に構築していきます。
また本書でのユーザー名はjitomeskyとしますので、ホームディレクトリの指定などでこの名前が出てきた場合は自分の環境にあわせて適宜変更してください。

WindowsやMacをユーザーの方は環境をそろえるため、仮想マシン上に構築することをおすすめします。

### Debianのインストール

Debianのインストール方法については省略します。
これについてわからないことがあれば、公式サイトにインストールガイドがあるので、それを参考にインストールを行ってください。

 * http://www.debian.or.jp/using/quick-etch/

インストールが終わったら必ずアップデートを行ってください。

```
$ sudo aptitude update
$ sudo aptitude -y upgrade
```

### クロス開発環境のインストール

OSのインストールが終わったところで、クロス開発環境を構築していきます。
ホスト開発環境しかない状態からターゲット用のクロス開発環境を作るというのは非常に面倒な作業で、通常この作業は次の手順を踏む必要があります。

##### 一般的なクロス開発環境の構築方法

 1.  binutilsのコンパイル
 2.  libcのヘッダのみ作成
 3.  libc構築用gccのコンパイル
 4.  libcの構築
 5.  gccのコンパイル

まずbinutils（GNU Binary Utilities）とは、アセンブラ、リンカおよびバイナリツールを含めたプログラミングツールです。
プログラムのコンパイルで一番重要なasやldなどはこのbinutilsに含まれているので、まずはこれをコンパイルする必要があります。
コンパイル時にターゲットを指定するオプションをつけることで、そのターゲット用のバイナリが作られます。（この時点ではクロスコンパイル環境はまだ必要ありません）

以降はお互いに強く依存しあっている標準Cライブラリ（libc）gccを交互に少しずつ作り上げて行きます。
この作業は1度経験してみればわかりますが、結構テクニカルで難しいです。そして何より非常に面倒です。

しかし、うれしい事にこの作業はすでに簡略化されており、大きく分けて以下の2つの方法で楽をすることができます。

 * コンパイル済みの環境を利用する（例: CodeSourcery, emdebian, YAGARTO）
 * 環境の自動生成スクリプトを利用する（例: Crosstool-NG, Ptxdist）

前者と後者を比較すると、前者の方が手っ取り早いですが、利用できる環境や目的が限られてしまいます。
逆に後者は、設定やコンパイルの手間がかかる代わりに、比較的自由な環境を作ることができます。

今回のBareMetal開発はマイコン開発と同じく、通常のGNU libc（glibc）などを利用しない少々特殊な環境が必要となるので、これから後者のcrosstool-NGを利用して構築を行っていきます。


#### crosstool-NGとは

crosstool-NGは、開発環境（toolchain）の構築を自動で行う、多目的なtoolchain生成ツールです。
このツールは多くのターゲットアーキテクチャ（ARMやMIPSなど）や、異なるコンポーネント（glibcやnewlib）、バージョンなどをサポートしています。
これらの組み合わせを設定ファイルに書き込み、ツールを走らせるだけで簡単にその組み合わせの開発環境を作ることができます。

また、一般的なターゲットアーキテクチャとコンポーネントの組み合わせにはすでにテンプレートが用意されており、テンプレートを利用することで設定の手間をある程度省くことができます。


#### 基本的なパッケージのインストール

まずは開発に必要な基本的なパッケージとcrosstools-NGに必要なパッケージをインストールします。
テキストエディタはvimもemacsも入れるので好きな方を使ってください。

```
$ sudo aptitude -y install build-essential vim emacs git \
  mercurial python3 python2.7 python-dev libzip-dev \
  automake libncurses5-dev gperf bison flex gawk \
  libtool libexpat-dev expat
```


#### 32bit環境用ライブラリのインストール

次に32bitアプリケーションのために32bitライブラリを追加します。 これを忘れると後から詰まることになるので注意してください。

```
$ sudo dpkg --add-architecture i386
$ sudo aptitude update
$ sudo aptitude -y install ia32-libs
$ sudo aptitude -y install libgtk2.0-0:i386
```


#### crosstool-NGのインストール

準備も整ったところで、crosstool-NGを使ってクロス開発環境を構築していきます。 crosstool-NGを利用した環境構築は、大まかに以下の3つの手順で行われます。

 1.  crosstool-NGのインストール
 1.  環境設定
 1.  コンパイルとインストール

まずはクロス開発環境をインストールするためのディレクトリを~/cross以下に作っていきます。ここにクロスコンパイラやcrosstool-NGをインストールしていきましょう。

```
$ mkdir -p ~/cross/rpi
$ mkdir ~/cross/src
```

まずはこのコマンドよりディレクトリを掘ります。クロスコンパイラはrpi以下、crosstool-NG等のソースコードはsrc以下に保存して行きます。

次にcrosstool-NGのインストールを行います。

```
$ cd ~/cross/src
$ wget http://crosstool-ng.org/download/crosstool-ng/crosstool-ng-1.19.0.tar.bz2
$ tar jxvf crosstool-ng-1.19.0.tar.bz2
$ cd crosstool-ng-1.19.0/
$ ./configure --prefix=/home/jitomesky/cross/
$ make
$ make install
```

この一連のコマンドでcrosstool-NGが ~/cross/binにインストールされます（wgetで持ってくるcrosstool-ngのバージョンは適宜変更してください） 。
コマンドの実態はこのディレクトリ以下のct-ngなので下記のように指定すれば、パスを通していなくても利用できます。

```
$ ~/cross/bin/ct-ng
```

次にクロスコンパイラの環境設定を持ってきます。
本リポジトリの ``` crosstool-ng/dot_sf_config ``` というファイルを ``` ~/cross/src/ct-ng_rpi ``` 以下のディレクトリに保存して ``` .config ``` にリネームしてください。

設定を持ってきたら、以下のコマンドでコンパイルとインストールを始めてください。

```
$ ~/cross/bin/ct-ng build
```

これには大体1時間程度かかるので、コーヒー休憩などで時間を潰してください。
特にエラーも出ずに終了すればコンパイルとインストールは完了です。
最後にこの環境が利用できるよう、

```
$ echo 'export PATH=$PATH:~/cross/rpi/arm-unknown-eabi/bin' >> ~/.bashrc
```

としてターミナル起動時にパスを通すように設定すれば、次回からクロス開発環境が利用できるようになります。

これでクロス開発環境の構築は終わりです。 おつかれさまでした。


## SDカードのセットアップ

動作確認が終わったらRaspberry Pi側のOSはもう使いません。
Linuxが動いていないことをより明確にするため、一度SDカードをフォーマットしてしまうことにします。
ただし一部のファイルは必要なのでまずはそのファイルを取り出します。


#### 必要なファイルの取り出し

まずはRaspberry PiからSDカードを取り外し、開発用のマシンで読み取ってください。するとbootという名前のパーティションがマウントされるはずなので、このパーティションの中身をどこか別のところにバックアップしてください。


#### SDカードのフォーマット

次にSDカードのフォーマットを行います。純正ツールをダウンロードし、必ずこの純正ツールを使いFATでフォーマットを行ってください。

 * https://www.sdcard.org/jp/downloads/formatter_4/


#### ファイルを戻す

フォーマットが終わったら、先ほどバックアップしたファイルをSDカードに戻します。
最初は必ずbootcode.binというファイルをコピーしてください。
その後は順番を気にせず、残りを全てSDカードにコピーしてください。

これでSDカードの準備は完了です。